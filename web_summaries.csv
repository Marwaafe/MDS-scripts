import os
from bs4 import BeautifulSoup
import pandas as pd

# List of samples to include
selected_samples = [
    "MDS005-09-247",
    "MDS006-08-249",
    "MDS010-09-299",
    "MDS016-09-478",
    "MDS023-10-053",
    "MDS029-10-118",
    "MDS038-10-241",
    "MDS059-10-531",
    "MDS065-10-609",
    "MDS154-13-486",
    "MDS155-13-606",
    "MDS167-13-913",
    "MDS169-13-919",
    "MDS180-14-164",
    "MDS189-14-527",
    "MDS201-15-093",
    "MDS212-15-463"
]

# Samples being rerun
being_rerun = [
    "MDS001-09-203"
]

root_dir = "MDS_Data/MDS_OUTS_CellRangerCount"
summary_data = []

for sample_name in selected_samples:
    sample_folder = f"{sample_name}_count_output"
    html_path = os.path.join(root_dir, sample_folder, f"{sample_name}_count", "outs", "web_summary.html")

    if os.path.exists(html_path):
        with open(html_path, "r", encoding="utf-8") as file:
            soup = BeautifulSoup(file, "html.parser")

            try:
                est_cells = int(soup.select_one('[data-testid="estimated-cells"]').text.replace(",", ""))
                mean_reads = int(soup.select_one('[data-testid="mean-reads-per-cell"]').text.replace(",", ""))
                median_genes = int(soup.select_one('[data-testid="median-genes-per-cell"]').text.replace(",", ""))
                total_reads = int(soup.select_one('[data-testid="number-of-reads"]').text.replace(",", ""))
                frac_reads_in_cells = float(soup.select_one('[data-testid="frac-reads-in-cells"]').text.strip('%'))
                median_umi = int(soup.select_one('[data-testid="median-umi-counts"]').text.replace(",", ""))
                seq_saturation = float(soup.select_one('[data-testid="sequencing-saturation"]').text.strip('%'))
                chemistry = soup.select_one('[data-testid="chemistry"]').text.strip()

                # Flagging logic
                comments = []
                if est_cells < 1000:
                    comments.append("Low cell yield")
                if sample_name in being_rerun:
                    comments.append("Being rerun")

                summary_data.append({
                    "Sample ID": sample_name,
                    "Estimated Number of Cells": est_cells,
                    "Mean Reads per Cell": mean_reads,
                    "Median Genes per Cell": median_genes,
                    "Total Reads": total_reads,
                    "Fraction Reads in Cells (%)": frac_reads_in_cells,
                    "Median UMI per Cell": median_umi,
                    "Sequencing Saturation (%)": seq_saturation,
                    "Chemistry": chemistry,
                    "Comments": "; ".join(comments)
                })

            except Exception as e:
                print(f"Error parsing {sample_name}: {e}")
    else:
        print(f"web_summary.html not found for {sample_name}")

# Write to CSV
df = pd.DataFrame(summary_data)
df.to_csv("MDS_Selected_Samples_Summary.csv", index=False)
print("Summary written to MDS_Selected_Samples_Summary.csv")
