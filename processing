
> geneNMF.metaprograms$metaprograms.genes.weights$MP1
      GNLY       NKG7       CCL5       GZMB     FGFBP2 
0.37130921 0.27397867 0.14127435 0.11382638 0.09961139 
> geneNMF.metaprograms$metaprograms.genes.weights$MP2
      RPS5     EEF1B2      RPL36     RPL36A      RPL22     RPL10A      EEF1G       RPL5       RPSA 
0.05051084 0.05027753 0.04414476 0.04116316 0.03598546 0.03466189 0.03261771 0.03151387 0.03128776 
     RPL32      RPL29      RPS4X     RPL35A     RPL18A      RPL12      RPS13      RPS14       RPS8 
0.03103728 0.03091265 0.03071940 0.02972146 0.02952838 0.02909333 0.02900594 0.02883795 0.02859171 
     RPS23      RPS28      RPS21       RPL7      RPL31      RPS18       GAS5       RPL9      RPL18 
0.02840369 0.02812485 0.02787546 0.02765768 0.02758003 0.02747067 0.02726833 0.02682841 0.02621706 
     RPS3A      RACK1      RPL19     RPL27A     RPS15A      RPL35 
0.02330653 0.02274867 0.02271082 0.02161914 0.02149802 0.02107957 
> geneNMF.metaprograms$metaprograms.genes.weights$MP3
      PDE3B        ZEB1      JARID2     SERINC5       BACH2       PRKCA      CNOT6L       NAMPT 
0.025306087 0.019411315 0.016972418 0.016544811 0.016124589 0.015878009 0.011785991 0.011303586 
      ITPKB     RAPGEF6       BTBD9       MAML2       PRKCE      BCL11B      ZBTB20        MSI2 
0.010925648 0.010614255 0.009657961 0.009610105 0.009531010 0.009402082 0.008851480 0.008702003 
      KLF12       SESN3       PRKCH        FHIT      CDKAL1      BTBD11   LINC01619        GAB2 
0.008631406 0.008352132 0.008328826 0.008225075 0.008212091 0.008121305 0.008113195 0.007997723 
   TMEM131L      ARID1B       KDM6A       SMYD3       SYNE1      CDC14A         FYN       ABCC1 
0.007771567 0.007754240 0.007594778 0.007582294 0.007540971 0.007519496 0.007377374 0.007302505 
     ZNF407       CD247      ATP2B1        CD83      HIVEP2    PPP1R16B       HERC1       IL6ST 
0.007233020 0.006992208 0.006984561 0.006952145 0.006930725 0.006906710 0.006777239 0.006684449 
       CMIP        BRD1      FNDC3B      CRYBG1      ATP8A1      DYRK1A        AKT3      MED13L 
0.006608155 0.006572227 0.006564294 0.006538955 0.006531285 0.006497228 0.006425943 0.006387720 
     MAN2A1       SSBP2       FOXO3       FOXO1         SKI        SNX9       UBE2H     DENND4A 
0.006273858 0.006243276 0.006230716 0.006181502 0.006159858 0.006146271 0.006007593 0.006006432 
     VPS13B         LYN       RASA3    ARHGAP26      DOCK10       SKAP1      MAN1A1      TGFBR2 
0.005995851 0.005955591 0.005891272 0.005872923 0.005839640 0.005830867 0.005807309 0.005758356 
     PIK3R5      EXOC6B      TNRC6C      CAMK1D        BCL2       EXOC4      HIVEP1     SIPA1L1 
0.005748841 0.005662954 0.005619603 0.005554371 0.005551270 0.005499143 0.005406254 0.005391603 
      HIF1A       RUNX1      CCDC91       SYTL3      PIK3CA       LMBR1     PITPNC1      CEMIP2 
0.005362369 0.005281386 0.005255395 0.005216804 0.005208873 0.005203575 0.005115369 0.005088552 
    TNFAIP3      MARCH6       PELI1       KMT2C       NEAT1       TBL1X        RORA      CHST11 
0.005057260 0.005038494 0.005018269 0.004947981 0.004917713 0.004902773 0.004895860 0.004894142 
      CMSS1        LRBA       STAT4       PARP8       PCNX1        DPYD       ELMO1        PAG1 
0.004843266 0.004831821 0.004704188 0.004661610 0.004615487 0.004590558 0.004587108 0.004562287 
      NRIP1    RALGAPA2        GRK5       PELI2        WWOX      TGFBR3        CBLB        PAN3 
0.004550175 0.004494214 0.004475792 0.004420825 0.004411149 0.004290871 0.004272538 0.004218071 
      MYO9B      ZFAND3         ATM      GPRIN3       TCF12         MTR     ATP13A3        AOAH 
0.004198384 0.004172709 0.004153820 0.004093443 0.004050817 0.004000868 0.003990050 0.003984779 
       CD69      NFKBIZ      CCSER2     TBL1XR1      KANSL1       USP9X      SUCLG2       TRAF3 
0.003934793 0.003895759 0.003872821 0.003854038 0.003810404 0.003775604 0.003703515 0.003696350 
      SYNE2       UBAP1        YES1         QKI        ETV6     TRAPPC9      CLASP1        SMG6 
0.003680697 0.003663858 0.003646403 0.003626728 0.003624179 0.003615429 0.003593539 0.003578517 
    RABGEF1       FKBP5     ANKRD28        BRAF      ZFAND6       DOCK2        TNKS         EZR 
0.003531047 0.003496016 0.003463302 0.003385841 0.003379791 0.003339734 0.003338364 0.003325466 
       GNG2         WRN       PTBP2      AMBRA1         BBX        RERE      GPCPD1     ANKRD11 
0.003313899 0.003308560 0.003304054 0.003275099 0.003259508 0.003234367 0.003220424 0.003188337 
     PPP6R3       EPB41       ARNTL       APMAP       CEP95      FBXL17       ARID2      ZNF331 
0.003182749 0.003181057 0.003168888 0.003152760 0.003139936 0.003128447 0.003126061 0.003098762 
     CLEC2D      TSPYL2        AKNA     TNFAIP8      PRRC2B       HSPD1      SMURF1        TNIK 
0.003098385 0.003093941 0.003079214 0.003071951 0.003066755 0.003055387 0.003049142 0.003011908 
    FAM214A        COG5       ARL15     RPS6KA5       PSME4        UBR5       ATXN7       PTPRE 
0.002983499 0.002976622 0.002976232 0.002959841 0.002941312 0.002899450 0.002889217 0.002886934 
      ITPR2        SIK3      POU2F1      AHCTF1        RYBP      RNF19A        FAF1     TBC1D15 
0.002880577 0.002870215 0.002854852 0.002848708 0.002845824 0.002815528 0.002797528 0.002795342 
      RNGTT     EIF2AK3         OGT     ARHGEF7        ZEB2        CHD6    RABGAP1L 
0.002781312 0.002774812 0.002769268 0.002765198 0.002752463 0.002724835 0.002720456 
> geneNMF.metaprograms$metaprograms.genes.weights$MP4
    S100A9     S100A8        LYZ       CST3 
0.38009955 0.36562452 0.18880471 0.06547122 
> geneNMF.metaprograms$metaprograms.genes.weights$MP6
       TUBB      TUBA1B     ATP5IF1     ATP5MC1     TMEM14B       HMGA1    SLC25A39       HSPD1 
0.161138192 0.099343864 0.048724769 0.044218573 0.043894058 0.038448788 0.034444781 0.028611407 
        BSG       H2AFZ    HIST1H4C       C1QBP        MPC2     ATP5MC3      ATP5MF       PA2G4 
0.026798746 0.026708820 0.026568722 0.025728893 0.021965348 0.020184887 0.019973677 0.017373380 
        RAN       SLIRP      TUBB4B      NDUFB6        NASP         TXN       SNRPE        CST3 
0.015340869 0.013203925 0.013010709 0.012730648 0.012285466 0.011465944 0.011381591 0.011117432 
 GADD45GIP1       VDAC3       NOP10        GYPC        CYC1       HMGB2     NDUFAB1     RPL22L1 
0.010942473 0.010867250 0.010789675 0.010733331 0.010368593 0.010107279 0.009509127 0.009212531 
      HSPE1       HSPB1      LGALS3      S100A6       HSPA8        TSPO       SNRPG        NHP2 
0.009152346 0.009134777 0.008692528 0.008282099 0.008240592 0.008103591 0.007997130 0.007945668 
    SLC25A5        RPS5      SNHG29        CCT8       COX5A      EEF1B2       UQCRQ        RBX1 
0.007806989 0.007772772 0.007427526 0.007203378 0.007179551 0.007178604 0.007080236 0.006954764 
       CCT2 
0.006653704 
> geneNMF.metaprograms$metaprograms.genes.weights$MP7
  HLA-DRA  HLA-DPB1  HLA-DRB1  HLA-DPA1 
0.3389374 0.2386723 0.2265014 0.1958890 
> geneNMF.metaprograms$metaprograms.genes.weights$MP8
        LTB        IL7R      FLT3LG        CD3E         CD2        CD3D       PDE3B        CD69 
0.216984599 0.185831502 0.089663151 0.034715656 0.023723910 0.023086543 0.022110187 0.021397845 
       JUNB       BACH2      BCL11B        IL32       NOSIP       ITPKB  PCED1B-AS1      CRYBG1 
0.021360463 0.020546681 0.020545415 0.019958388 0.019572952 0.019460128 0.016499909 0.015830805 
     IFITM1     TNFAIP3         JUN         CD7      DNAJB1       SESN3        ZEB1       KLRB1 
0.014549170 0.014528675 0.014528549 0.014481729 0.014083996 0.014082919 0.013446095 0.012884959 
    SERINC5        KLF6        GZMM        KLF2       PRKCA         EZR       DUSP2      ARID5B 
0.012441440 0.010642346 0.010533732 0.010029266 0.009870851 0.009589854 0.009308420 0.009158368 
      COTL1     SEPTIN1     RAPGEF6     S100A10 
0.008786901 0.008702986 0.008614791 0.008446818 
> geneNMF.metaprograms$metaprograms.genes.weights$MP10
  SLC25A39     HECTD4        BSG       WNK1      NUDT4      EPB41       UBR2       MXI1      UBE2H 
0.13400501 0.11517942 0.09692626 0.08015012 0.07057788 0.06853093 0.05834094 0.04674308 0.04129058 
    BNIP3L     GAPVD1       PIM1     MAN1A1      FOXO3     RAD23A      MARK3      MACO1       KLF3 
0.03824632 0.03779742 0.03459680 0.03400232 0.03376816 0.03105768 0.02774172 0.02588463 0.02516075 


library(Seurat)
library(Matrix)
library(ggplot2)
library(patchwork)
library(dplyr)
library(clustree)
library(UCell)
library(RColorBrewer)
library(GeneNMF)

sample_names <- c(
  "MDS001-09-203", "MDS005-09-247", "MDS006-08-249", "MDS010-09-299",
  "MDS016-09-478", "MDS023-10-053", "MDS029-10-118", "MDS038-10-241",
  "MDS059-10-531", "MDS065-10-609", "MDS154-13-486", "MDS155-13-606",
  "MDS167-13-913", "MDS169-13-919", "MDS180-14-164", "MDS189-14-527",
  "MDS201-15-093", "MDS212-15-463"
)

seurat_list <- lapply(sample_names, function(name) {
  readRDS(file.path("/trinity/home/mafechkar/MDS_Data", paste0(name, "_SeuratObj.rds")))
})
names(seurat_list) <- sample_names
merged_seurat <- merge(
  x = seurat_list[[1]],
  y = seurat_list[-1],
  add.cell.ids = sample_names,
  project = "MDS_Merged",
  merge.data = TRUE  # keep normalized RNA and ADT layers
)

merged_seurat$orig.ident <- sapply(strsplit(colnames(merged_seurat), "_"), `[`, 1)

#Normalize using LogNormalize with median scaling factor
median_umi <- median(merged_seurat$nCount_RNA)
print(median_umi)
merged_seurat_log <- NormalizeData(merged_seurat, normalization.method = "LogNormalize", scale.factor = median_umi)

#Detecting Batch effect
merged_seurat_log <- FindVariableFeatures(merged_seurat_log)
merged_seurat_log <- ScaleData(merged_seurat_log)
merged_seurat_log <- RunPCA(merged_seurat_log)
DimPlot(merged_seurat_log, reduction = "pca", group.by = "orig.ident")

#set RNA assay as default and split object by sample 
DefaultAssay(merged_seurat_log) <- "RNA"
seurat_list <- SplitObject(merged_seurat_log, split.by = "orig.ident")

common_genes <- Reduce(intersect, lapply(seurat_list, function(x) rownames(x)))

seurat_list <- lapply(seurat_list, function(x) {
  x[common_genes,]
})

#Run NMF across multiple k values
geneNMF.programs <- multiNMF(seurat_list, assay = "RNA", k = 4:9, min.exp = 0.05)

#Collapse those programs into consensus metaprograms (MPs)
geneNMF.metaprograms <- getMetaPrograms(
  geneNMF.programs,
  metric = "cosine",
  weight.explained = 0.5,
  nMP = 10
)

ph <- plotMetaPrograms(geneNMF.metaprograms, similarity.cutoff = c(0.1, 1))

geneNMF.metaprograms$metaprograms.metrics

keep_mps <- c("MP1", "MP2", "MP3", "MP4", "MP6", "MP7", "MP8", "MP10")
filtered_metaprograms <- geneNMF.metaprograms$metaprograms.genes[keep_mps]

str(filtered_metaprograms)

#identify non wanted genes by prefix 
ALs <- grep('^AL[0-9]',rownames(merged_seurat_log[['RNA']]),value = TRUE)
ACs <- grep('^AC[0-9]',rownames(merged_seurat_log[['RNA']]),value = TRUE)
ADs <- grep('^AD[0-9]',rownames(merged_seurat_log[['RNA']]),value = TRUE)
APs <- grep('^AP[0-9]',rownames(merged_seurat_log[['RNA']]),value = TRUE)
EFs <-  grep('^EEF',rownames(merged_seurat_log[['RNA']]),value = TRUE)
LINCs <-  grep('^LINC',rownames(merged_seurat_log[['RNA']]),value = TRUE)

#combine into a single gene list
genes_to_remove <- c('MALAT1','LNCAROD','IGKC', ALs, ACs, ADs,APs,EFs,LINCs)
merged_seurat_log[['RNA']] <- subset(merged_seurat_log[['RNA']], features = setdiff(rownames(merged_seurat_log[['RNA']]), genes_to_remove))

