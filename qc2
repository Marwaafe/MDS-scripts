
> isotypes <- c("IgG1_control_TotalSeqB", "IgG2a_control_TotalSeqB", "IgG2b_control_TotalSeqB")
> cells.dsb.norm <- DSBNormalizeProtein(
+     cell_protein_matrix = cell.adt.raw,
+     empty_drop_matrix = background.adt.mtx,
+     denoise.counts = TRUE,
+     use.isotype.control = TRUE,
+     isotype.control.name.vec = isotypes
+ )
Error in DSBNormalizeProtein(cell_protein_matrix = cell.adt.raw, empty_drop_matrix = background.adt.mtx,  : 
  some elements of isotype.control.name.vec are not in input data rownames: 
cell_protein_matrix - IgG1_control_TotalSeqB 
empty_drop_matrix - IgG1_control_TotalSeqBsome elements of isotype.control.name.vec are not in input data rownames: 
cell_protein_matrix - IgG2a_control_TotalSeqB 
empty_drop_matrix - IgG2a_control_TotalSeqBsome elements of isotype.control.name.vec are not in input data rownames: 
cell_protein_matrix - IgG2b_control_TotalSeqB 
empty_drop_matrix - IgG2b_control_TotalSeqB

# Load libraries
library(Seurat)
library(Matrix)
library(ggplot2)
library(patchwork)
library(dsb)
library(ComplexHeatmap)
library(circlize)
library(dplyr)

# Define paths
sample_name <- "MDS005-09-247"
raw_path <- file.path(
  "/trinity/home/mafechkar",
  "MDS_OUTS_CellRangerCount_9.0",
  paste0(sample_name, "_count_output"),
  paste0(sample_name, "_count"),
  "outs",
  "raw_feature_bc_matrix"
)
filtered_path <- file.path(
  "/trinity/home/mafechkar",
  "MDS_OUTS_CellRangerCount_9.0",
  paste0(sample_name, "_count_output"),
  paste0(sample_name, "_count"),
  "outs",
  "filtered_feature_bc_matrix"
)

# Load data
raw <- Read10X(raw_path)
cells <- Read10X(filtered_path)

# Separate barcodes
stained_cells <- colnames(cells$`Gene Expression`)
background <- setdiff(colnames(raw$`Gene Expression`), stained_cells)

# Split modalities
prot <- raw$`Antibody Capture`
rna <- raw$`Gene Expression`

# Create metadata for QC
mtgene <- grep(pattern = "^MT-", rownames(rna), value = TRUE)
md <- data.frame(
  rna.size = log10(Matrix::colSums(rna)),
  prot.size = log10(Matrix::colSums(prot)),
  n.gene = Matrix::colSums(rna > 0),
  mt.prop = Matrix::colSums(rna[mtgene, ]) / Matrix::colSums(rna)
)
md$drop.class <- ifelse(rownames(md) %in% stained_cells, 'cell', 'background')
md <- md[md$rna.size > 0 & md$prot.size > 0, ]

# Define background droplets
background_drops <- rownames(md[ md$prot.size > 1.5 & md$prot.size < 3 & md$rna.size < 2.5, ])
background.adt.mtx <- as.matrix(prot[, background_drops])

# QC cells
cellmd <- md[md$drop.class == 'cell', ]
rna.mult <- (3*mad(cellmd$rna.size))
prot.mult <- (3*mad(cellmd$prot.size))
rna.lower <- median(cellmd$rna.size) - rna.mult
rna.upper <- median(cellmd$rna.size) + rna.mult
prot.lower <- median(cellmd$prot.size) - prot.mult
prot.upper <- median(cellmd$prot.size) + prot.mult

qc_cells <- rownames(cellmd[cellmd$prot.size > prot.lower & 
                              cellmd$prot.size < prot.upper & 
                              cellmd$rna.size > rna.lower & 
                              cellmd$rna.size < rna.upper & 
                              cellmd$mt.prop < 0.14, ])

# Subset matrices
cell.adt.raw <- as.matrix(prot[, qc_cells])
cell.rna.raw <- rna[, qc_cells]
cellmd <- cellmd[qc_cells, ]

# Remove 'nan' features
cell.adt.raw <- cell.adt.raw[!grepl("^nan", rownames(cell.adt.raw)), ]
background.adt.mtx <- background.adt.mtx[rownames(cell.adt.raw), ]

# Normalize ADT with DSB
isotypes <- c("IgG1_control_TotalSeqB", "IgG2a_control_TotalSeqB", "IgG2b_control_TotalSeqB")
cells.dsb.norm <- DSBNormalizeProtein(
  cell_protein_matrix = cell.adt.raw,
  empty_drop_matrix = background.adt.mtx,
  denoise.counts = TRUE,
  use.isotype.control = TRUE,
  isotype.control.name.vec = isotypes
)

# Create Seurat object
s <- CreateSeuratObject(counts = cell.rna.raw, meta.data = cellmd)
s[["ADT"]] <- CreateAssayObject(data = cells.dsb.norm)

# Cluster based on ADT
DefaultAssay(s) <- "ADT"
VariableFeatures(s) <- rownames(s[["ADT"]])
s <- FindNeighbors(object = s, dims = NULL, assay = "ADT", features = VariableFeatures(s))
s <- FindClusters(object = s, resolution = 1, algorithm = 3, graph.name = "ADT_snn")

# Identify RNA markers
DefaultAssay(s) <- "RNA"
Idents(s) <- "ADT_snn_res.1"
s <- NormalizeData(s)
s <- FindVariableFeatures(s)
s <- ScaleData(s)
rna_markers <- FindAllMarkers(s, only.pos = TRUE, verbose = FALSE)
top_genes <- rna_markers %>% 
  dplyr::filter(avg_log2FC > 1) %>%
  dplyr::group_by(cluster) %>%
  dplyr::top_n(n = 3, wt = avg_log2FC) %>%
  dplyr::pull(gene) %>%
  unique()

# Aggregate expression by cluster
adt_data <- t(GetAssayData(s, assay = "ADT", slot = "data"))
rna_data <- t(GetAssayData(s, assay = "RNA", slot = "data")[top_genes, ])
df <- cbind(s@meta.data, adt_data, rna_data)

heatmap_data <- df %>%
  dplyr::group_by(ADT_snn_res.1) %>%
  dplyr::summarize(across(where(is.numeric), median)) %>%
  tibble::column_to_rownames("ADT_snn_res.1")

# Plot combined heatmap
adt_features <- rownames(s[["ADT"]])
protein_data <- t(heatmap_data[, adt_features])
rna_data_scaled <- t(scale(t(heatmap_data[, top_genes])))

prot_col <- circlize::colorRamp2(seq(0, 30, by = 1), viridis::viridis(31, option = "B"))
rna_col <- circlize::colorRamp2(c(-2, -1, 0, 1, 2), colorspace::diverge_hsv(n = 5))

h1 <- Heatmap(protein_data, name = "protein", col = prot_col, row_names_gp = gpar(fontsize = 6), use_raster = TRUE)
h2 <- Heatmap(rna_data_scaled, name = "mRNA", col = rna_col, row_names_gp = gpar(fontsize = 6), use_raster = TRUE)

draw(h1 %v% h2)
